#!/usr/bin/python3
# Author: Dylan Evans|fin3ss3g0d
import os, sys, json, argparse
import log
from log import log_default
from query_shell import QueryShell


banner = """:::::::------::-----::::-------::---------::-----------------=+++*++=++***++===+**######*++++**#####*****+===+===-----=+
:::::::------::------::::-------:-------::::-----------------===++++++****++===+**#%%%%##***+**#######**++==++++==----=+
::::::-------::------::::-------:------::::::---:::::::...:::-==++*++**++*++===+*##%%%%%##*+++**##**#***++==+++++=---==+
:::::--------::------:::::------::---::::::::::::::--==+*###%%%%#*+=+++++++====+**###%###**+++******###**+===+++==---=++
:::::--===---::-------::::------:::-::::::.:-=+***#%@@@%@@@%%@@@@@@*==+++++====+**######*++++**########**+===+++==--==++
::::---===---::--------:::------::::::::.:+#%%%%%%@@@%#+=+*###%%%%%@%+=========**######*+++++*##########*+==++++=====+++
::::---===----:---------:-------:::::::-=######*++**#*==--++##%%%#%%@@#+--====+**#%%%%##*++++*######%###*+++++++==--==++
::::--====---::-----------------::::::-+*=****+=-:=+**+=-====+#%%###%%%@%+=--=+*##%%%%##*++++**####%%%##*+++++++==---=+*
-:-----===---::------------------::::::-:+#*=:..-++=+**+==-::-*####%%%##%@%+=-=**#%%%%#**++=++**##%%%%%#**====+===---=+*
------====----:--------------=---:::::.-**=-.   :=**+====-::-:--=*%%%@%###%@%*=+*######*++==++*###%%%%##*++=======---=+*
-----======----------------===----:::-*%#=:.      .=*+==-::::=:-**####%#####%%%*+*###**++===++*####%%##**++=======--==+#
-----=======----------------==---::-=%%*-::. ..:-:. -+=-:.:.--:*###%%%%#*########*****+++===++*###%###**+==========-==*#
-----========-------------------=+**++++=::::.::...  -+:...:-:*%####%%@%++******###*+*+++===++**###***++===========-==*#
=============---------------=+**++++=====---=-:::::-::+:...::=#####*+*#@%+=+=+*++*##*+++++++++++*****+===--===========+*
=============-------------+**+=::-======-=====---:--::=. . .:-*****++++*%#*+=++++*+##*++++++++++****++===--==========++*
====++=======-----------+*+-::::::--=========+++===---=.   ..:+++++*****##++*++*+++*###++++++++++****++===============++
==+++++++===-----------=**+==:....:-====----======++-:=. ..-:-+++++++****+=*****+++=+*##+===++=++****+++================
==+++++++=============-. .:---....::------::-+====++=-=: :-=:==+++++++***=-+****+===++*%%#+====+++++*******+++++====+++=
=======================-    ....   ::::----===+++++=--=:.-=:-=-=====+++**=-++*#*+==+=+**#%%#*+++++***######**+++======++
========================- ..... ....:::--:-==-==-===-:=..=-.-=-======++-+==*****======+*+*##%%#***##%%%%%##*++++====+++=
====================----=- .  ....:.:.::::----=====-:::.-- :-=----==-==:=++#**+==---====+*++++******#%%##********+++*+++
================---------= ..............::---====-:::.:- .:-===+===--=--=+##++=:-=:-:-::--:-========*###*==+*#%%%####*+
============--------------. ............:-----===-::...: .::--=======--=--+++=-::::.::::::::::::=====+++*+===+++*+==+=--
=========------------------  .........::----:-----:...: ..:----=---::.:--:--::......::...:::::::-----==---==--: . .:--==
-==-------------------=====-.  ...::::::-:::.:-===-.::-. .:---==---:::-=:.:.............:::::::::--==--:::---. . .---=+-
===------------==--==========:.    ....::.:...:-::::---. .:----:::::---+:.::-::::::..:::::::.:::---:::..:---.   .::-.--.
**+++++++++++++++++++***+++++++=-:.. ....... .....:--=-: .:---::::::----:--=---::::::::::::::.::::....::--:.    ::--=:.:
##**#######********#***********#####+    ... ...:-:--==- .-=--:::::::::::--==+---:-=+=--:--:.::::....:::-:     .::-:. :-
######%%%%%#####################%%%%@:   .:... .::::--=:.:---:::.::::. ::--+=======+==++=-::-::::..::::::     .:-::. :--
*######%%%%####################%%%%%@#.    .   .:.::--: :-----::::::. :=--==++=---=+=++=+===--::..:--::.      ..::. .::-
#######%########################%%%%%%%+=---:..:..:::-..:-:----:::.  .:-:---=------++====++===-:..::::          .:. .:::
########################%%############%%%%@%:.::::::::.::-==+-:.    .:::---=---==--===--======+-::::.  ..           .:::
***************###########################%: .:....:-:::-=-:.      ...---=++=============+=++==..::.........        ....
++++*****+++++++*************************##+.::...  ::::::.        .::-==+*+++==+=+===+=*++*=::.:::....:.....    ..  ...
+++++********++++++++++**+++********+++++**#=....  .-=-::::..      .:-==**+++++**+++**+++=-::---::---:::.:...   .       
++++*****##**************+++++******++++++++*+-:.:-*##*+-::...... .:=++++====-==---===---::=++++++==----::::.   .       
++******************++***++++++++++*+++++++*+***+**++++**==-::....:=++==----....:::::-====++***+*++==---:::....   .     
++*+++++++++++++++++++++++++++==+++++++++*****+++++++++*******+..:-====-:::.:--::-==++++********++=====----........     
=++===========+++++=====+++++++=++++++++++++++++++++++*********=:::-:..:::-------=++****#######**++=-====--.:. .. .     
=========++++*****+++++==+++++++========+++++++++++++++********+-::-. .::--++===++******#######**++=-=--==-:.. ..       

                                      cypherhound (Author: Dylan Evans|fin3ss3g0d)
"""


def main() -> None:
    parser = argparse.ArgumentParser(description="Python terminal app that runs various Neo4j cyphers.")
    parser.add_argument("-c", "--config", help="Config file", required=True)
    parser.add_argument("-y", "--yaml", help="Path to queries YAML file", default="queries.yaml")
    args = parser.parse_args()

    # Read the config file
    try:
        with open(args.config) as f:
            config = json.load(f)
    except (FileNotFoundError, json.JSONDecodeError) as e:
        log.log_error(e)
        sys.exit(1)    

    # Check if yaml file exists
    if not os.path.exists(args.yaml):
        log.log_error(f"YAML file '{args.yaml}' does not exist.")
        sys.exit(1)

    # Display the banner
    log_default(banner)

    # Run the shell loop
    try:
        # Initialize the query shell
        shell = QueryShell(
            user=config.get("user"),
            pwd=config.get("pwd"),
            db=config.get("database", "neo4j"),
            yaml_file=args.yaml,
            persistent_history_file=".history"
        )
        shell.cmdloop()                      # drops into the REPL
    except Exception as e:
        log.log_error(e)        
    finally:
        shell.driver.close()                 # tidy shutdown
        sys.exit(1)


if __name__ == "__main__":
    main()
