#!/usr/bin/python3
# Author: Dylan Evans|fin3ss3g0d
import argparse
import terminal
import readline
import sys
import signal
import log
import json
import atexit
import os


def signal_handler(sig, frame):
    log.log_error("Exit program with 'q', 'quit', 'exit', or 'stop'")
    print(": ", end="")
            
            
banner = """:::::::------::-----::::-------::---------::-----------------=+++*++=++***++===+**######*++++**#####*****+===+===-----=+
:::::::------::------::::-------:-------::::-----------------===++++++****++===+**#%%%%##***+**#######**++==++++==----=+
::::::-------::------::::-------:------::::::---:::::::...:::-==++*++**++*++===+*##%%%%%##*+++**##**#***++==+++++=---==+
:::::--------::------:::::------::---::::::::::::::--==+*###%%%%#*+=+++++++====+**###%###**+++******###**+===+++==---=++
:::::--===---::-------::::------:::-::::::.:-=+***#%@@@%@@@%%@@@@@@*==+++++====+**######*++++**########**+===+++==--==++
::::---===---::--------:::------::::::::.:+#%%%%%%@@@%#+=+*###%%%%%@%+=========**######*+++++*##########*+==++++=====+++
::::---===----:---------:-------:::::::-=######*++**#*==--++##%%%#%%@@#+--====+**#%%%%##*++++*######%###*+++++++==--==++
::::--====---::-----------------::::::-+*=****+=-:=+**+=-====+#%%###%%%@%+=--=+*##%%%%##*++++**####%%%##*+++++++==---=+*
-:-----===---::------------------::::::-:+#*=:..-++=+**+==-::-*####%%%##%@%+=-=**#%%%%#**++=++**##%%%%%#**====+===---=+*
------====----:--------------=---:::::.-**=-.   :=**+====-::-:--=*%%%@%###%@%*=+*######*++==++*###%%%%##*++=======---=+*
-----======----------------===----:::-*%#=:.      .=*+==-::::=:-**####%#####%%%*+*###**++===++*####%%##**++=======--==+#
-----=======----------------==---::-=%%*-::. ..:-:. -+=-:.:.--:*###%%%%#*########*****+++===++*###%###**+==========-==*#
-----========-------------------=+**++++=::::.::...  -+:...:-:*%####%%@%++******###*+*+++===++**###***++===========-==*#
=============---------------=+**++++=====---=-:::::-::+:...::=#####*+*#@%+=+=+*++*##*+++++++++++*****+===--===========+*
=============-------------+**+=::-======-=====---:--::=. . .:-*****++++*%#*+=++++*+##*++++++++++****++===--==========++*
====++=======-----------+*+-::::::--=========+++===---=.   ..:+++++*****##++*++*+++*###++++++++++****++===============++
==+++++++===-----------=**+==:....:-====----======++-:=. ..-:-+++++++****+=*****+++=+*##+===++=++****+++================
==+++++++=============-. .:---....::------::-+====++=-=: :-=:==+++++++***=-+****+===++*%%#+====+++++*******+++++====+++=
=======================-    ....   ::::----===+++++=--=:.-=:-=-=====+++**=-++*#*+==+=+**#%%#*+++++***######**+++======++
========================- ..... ....:::--:-==-==-===-:=..=-.-=-======++-+==*****======+*+*##%%#***##%%%%%##*++++====+++=
====================----=- .  ....:.:.::::----=====-:::.-- :-=----==-==:=++#**+==---====+*++++******#%%##********+++*+++
================---------= ..............::---====-:::.:- .:-===+===--=--=+##++=:-=:-:-::--:-========*###*==+*#%%%####*+
============--------------. ............:-----===-::...: .::--=======--=--+++=-::::.::::::::::::=====+++*+===+++*+==+=--
=========------------------  .........::----:-----:...: ..:----=---::.:--:--::......::...:::::::-----==---==--: . .:--==
-==-------------------=====-.  ...::::::-:::.:-===-.::-. .:---==---:::-=:.:.............:::::::::--==--:::---. . .---=+-
===------------==--==========:.    ....::.:...:-::::---. .:----:::::---+:.::-::::::..:::::::.:::---:::..:---.   .::-.--.
**+++++++++++++++++++***+++++++=-:.. ....... .....:--=-: .:---::::::----:--=---::::::::::::::.::::....::--:.    ::--=:.:
##**#######********#***********#####+    ... ...:-:--==- .-=--:::::::::::--==+---:-=+=--:--:.::::....:::-:     .::-:. :-
######%%%%%#####################%%%%@:   .:... .::::--=:.:---:::.::::. ::--+=======+==++=-::-::::..::::::     .:-::. :--
*######%%%%####################%%%%%@#.    .   .:.::--: :-----::::::. :=--==++=---=+=++=+===--::..:--::.      ..::. .::-
#######%########################%%%%%%%+=---:..:..:::-..:-:----:::.  .:-:---=------++====++===-:..::::          .:. .:::
########################%%############%%%%@%:.::::::::.::-==+-:.    .:::---=---==--===--======+-::::.  ..           .:::
***************###########################%: .:....:-:::-=-:.      ...---=++=============+=++==..::.........        ....
++++*****+++++++*************************##+.::...  ::::::.        .::-==+*+++==+=+===+=*++*=::.:::....:.....    ..  ...
+++++********++++++++++**+++********+++++**#=....  .-=-::::..      .:-==**+++++**+++**+++=-::---::---:::.:...   .       
++++*****##**************+++++******++++++++*+-:.:-*##*+-::...... .:=++++====-==---===---::=++++++==----::::.   .       
++******************++***++++++++++*+++++++*+***+**++++**==-::....:=++==----....:::::-====++***+*++==---:::....   .     
++*+++++++++++++++++++++++++++==+++++++++*****+++++++++*******+..:-====-:::.:--::-==++++********++=====----........     
=++===========+++++=====+++++++=++++++++++++++++++++++*********=:::-:..:::-------=++****#######**++=-====--.:. .. .     
=========++++*****+++++==+++++++========+++++++++++++++********+-::-. .::--++===++******#######**++=-=--==-:.. ..       

                                      cypherhound (Author: Dylan Evans|fin3ss3g0d)
"""

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Python terminal app that runs various Neo4j cyphers on BloodHound data sets.")
    parser.add_argument("-c", "--config", help="Config file", required=True)
    parser.add_argument("-y", "--yaml", help="Path to queries YAML file", default="queries.yaml")
    args = parser.parse_args()

    try:
        with open(args.config) as f:
            config = json.load(f)
    except (FileNotFoundError, json.JSONDecodeError) as e:
        log.log_error(e)
        sys.exit(1)    

    try:
        print(f'{log.default}{banner}{log.reset}')
        readline.set_completer(terminal.Completer(terminal.OPTIONS).complete)
        readline.parse_and_bind('tab: complete')
        histfile = ('.history')
        if not os.path.exists(histfile):
            open(histfile, 'w').close()  # Creates an empty file if it doesn't exist    
        readline.read_history_file(histfile)
        atexit.register(readline.write_history_file, histfile)
        signal.signal(signal.SIGINT, signal_handler)        
        term = terminal.Terminal(config["user"], config["pwd"], config["database"], args.yaml)
        term.input_loop()
    except Exception as e:
        log.log_error(e)
        sys.exit(1)
